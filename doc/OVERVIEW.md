- 모든 코드와 문서는 https://github.com/taekyung81 에 있습니다. 온라인으로 보면 더 편합니다.
- 문서의 시작 https://github.com/taekyung81/hserver/blob/master/doc/OVERVIEW.md
---
 

## 시작 하기전
* GRPC 를 사용해본 적이 없기 때문에 grpc 와 protobuf 를 우선 봤다.  
  그리고 시간적 제약 때문에 가장 익숙한 자바로 grpc 서비스를 구현 할 수 있는 armeria 의 예제 코드를 함께 보기 시작헀다.
  
* 요구사항은 간단하지만, 구현의 해야하는 범위가 너무 오픈되어 있었다. 그래서 어디까지 어떤 수준으로 구현할지 고민이 생겼다.
  - 실행 파일을 제출하라고 했으니 실행이 쉽도록 dockeize 하거나 execuable jar로 만들어야겠다
  - 대량의 트래픽의 전송받을 서비스이니까 prometheus metric을 추가하고 docker 안에 grafna 도 넣어야겠다
  - 클라이언트도 제출해야하니까 브라우저에서 차량의 이동을 보여주면 좋을 것 같네. 근데 복잡하니까 위도,경도를 1 정도로만 제한해야겠다
  - 시스템이 죽어도 정상 동작 해야하고 DB를 사용하지는 못하니까 File-Storage를 이용해야겠다. bigqueue 밖에 없는데 이건 너무 오래되었고 버그가 존재한다. 이게 가장 어려운 작업이 될 것 같군
  - 검색은 어떻게 하지? 위경도를 역색인해야하나? 소수점 5자리가 미터단위니까 대략 1km 단위로 색인 하면 될까?
  
  하지만 고민만 많았고 산출물은 소소했다....
  
## 가정한 사설과 결정된 사항

### 위경도와 거리, 속도에 대한 가정 
* 위도와 경도는 double 이 아닌 int 로 사용하기로 결정했다
  * 위도는 -90 ~ +90 경도는 -180 ~ +180 까지이며, 일반적으로 소숫점 6-7자리까지 표현한다 
    
    도심지에서 차량이 이동할 때 37.000000 에서 37.000005 이렇게 움직인다는 건데 이걸 그대로 double로 저장할 경우, 
    -  int 보다 데이터 크기가 크다는 점. 
    -  부동소수점 연산이 int 보다 무겁다는 점, 
    -  그리고 소숫점 7자리에서의 연산이 정확히 될까?
    
    이러한 의문들이 들어서 int(4byte) 로 위경도를 표현하기로 결정하였다.
    
* 위,경도는 소숫점 5번째 자리까지만 측정한다 
  * 대략 위도 1.0 이 거리로는 110km 으로 생각하면  위도 0.00001 은 약 1 미터로 볼 수 있다. 
    차량의 크기가 2m 임을 감안하면 위도 '0.00001'도 충분히 의미있는 기록값이므로  소수 5자리까지 측정하기로 했다'
    그래서 위도 37.00001 을 실제로는 '3700001' 경도 127.12345 는 '12712345'로 사용한다.
    
* 이렇게 가정함으로써 속도/거리 계산도 샘플 프로젝트 답계 아주 간단해졌다.
  도심지의 평균 속도를 18 km/h 로 가정하면 5 m/s 이고, 0.00005 만큼 위경도가 변화한다고 가정 하였다.
                
* 테스트 데이터 등은 위도37.0 경도127.0 을 기준으로 랜덤 방향으로 움직이다. 그래서 모든 테스트도 `위도 37 경도 127` 를 기준으로 한다.


### 네트워크의 불안정함
* 자동차의 통신 상태는 불안정하다. & 터널 안에서는 통신이 안될 수 있고, 사고가 난다면 통신 기능이 마비될 수도 있다
* 자동차 네트워크 
  * 위치 정보가 발생하는 즉시 서버에 저장된다는 생각은 버리고, 자동차 내부적으로  데이터를 안전하게 저장 할 수 있는 저장소가 필요하다
    * 데이터를 저장하는 것과, 데이터를 전송하는 것은 독립적으로 진행이 되어야 한다
    * 그리고 네트워크 속도에 따라 데이터 전송 크기도 변경이 되어야 하고, retry 나 requeue 같은 정책도 필요하다
  * 고민은 이렇게 하지만... 전체 다 할수는 없기에 단순한 Memory-Queue ,  Network Client를 구현하기로 한다
* 서버 네트워크
  * Client 는 서버만 동작한다면 계속 데이터를 보낼 것이다. 하지만 서버쪽에서도 데이터를 받고 싶지 않은 상황이 있다.
    (장애 상태, 데이터 마이그레이션이라 몇 초간의 순단이 필요한 경우) 
    
    이럴 때 Put 의 응답 결과로 '데이터 느리게 보내기', '1분만 멈추기' 등을 고려하면 좋을 것 같다.
    
    
## 산출물
* Server Project - https://github.com/taekyung81/hserver
  * endpoint : gproto+http://127.0.0.1:8081/
    * http all 메소드 : http://127.0.0.1:8081/all
    * http get 메소드 : http://127.0.0.1:8081/car/T1
  * docService : http://127.0.0.1:8081/docs/
* API Tester Project - https://github.com/taekyung81/hclient
* 추가 문서
  * [아키텍쳐](./DESIGN_ARCHITECUTURE.md)
  * [실행 방법과 화면](./RUN.md)
  * [테스트 데이터 생성기와 커맨드 라인 테스터기](./DESIGN_CLIENT.md)]
           
